<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KnockoutJS + C#.NET WebApi 2</title>
    <link rel="stylesheet" type="text/css" href="../Content/Site.css" />
    <link rel="stylesheet" type="text/css" href="../Content/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../Content/bootstrap.custom.css" />
    <link rel="stylesheet" type="text/css" href="../Content/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="../Content/waitMe.min.css" />
</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a href="/Home/Index" class="navbar-brand">SDJ Gestor</a>
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="/Home/Index">Home</a></li>
                    <li><a href="/Help/Index">Help</a></li>
                    <li><a href="/WebPages/subcontas.html">Subcontas</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="container body-content">

        <!-- Conteudo -->
        <div class="page-header">
            <h1>Subcontas <small>- exemplo -</small></h1>

            <!-- Caminho do pão (breadcrumb) -->
            <ol class="breadcrumb">
                <li><a href="/Home/Index">Início</a></li>
                <li class="active">Subcontas</li>
            </ol>
        </div>

        <!-- Formulario principal: pesquisa + resultado -->
        <div class="panel panel-primary">

            <!-- Default panel contents -->
            <div class="panel-heading">Informe apenas UM dos campos abaixo para pesquisa...</div>
            <div class="panel-body">

                <form id="formPesquisaSubconta" class="form-inline" data-bind="submit: GetSubcontas">
                    <div class="form-group">
                        <label for="inputSubconta">Subconta</label>
                        <input type="text" class="form-control" id="inputSubconta" placeholder="__________" style="width: 120px;" maxlength="10" data-bind="textInput: pSubconta, hasfocus: true">
                    </div>
                    <div class="form-group">
                        <label for="inputProcesso">Processo</label>
                        <input type="text" class="form-control" id="inputProcesso" placeholder="____________________" style="width: 200px;" maxlength="20" data-bind="textInput: pProcesso">
                    </div>
                    <div class="form-group">
                        <label for="inputTitular">Nome Titular</label>
                        <input type="text" class="form-control" id="inputTitular" placeholder="Até 100 caracteres..." maxlength="100" data-bind="textInput: pTitular">
                    </div>

                    <button type="submit" id="botaoPesquisarSubconta" class="btn btn-primary" data-bind="enable: isExibirBotaoPesquisar()">
                        <i class="fa fa-search"></i> Pesquisar
                        <!--<span class="glyphicon glyphicon-search" aria-hidden="true"></span> Pesquisar-->
                    </button>

                    <button type="button" id="botaoLimparCampos" class="btn btn-default" data-bind="click: LimparCampos">
                        <!--<span class="glyphicon glyphicon-erase" aria-hidden="true"></span> Limpar-->
                        <i class="fa fa-eraser"></i> Limpar
                    </button>
                </form>

            </div>

            <!-- Table -->
            <div data-bind="fadeVisible: isExibirPainelResultado()">
                <div class="alert alert-info">
                    <span class="badge badge-info" data-bind="text: listaSubcontas().length"></span> <small>subconta(s) encontradas.</small>
                </div>

                <table class="table table-bordered table-striped table-hover">
                    <tr>
                        <th>Nº Subconta</th>
                        <th>Saldo</th>
                        <th>Data Abertura</th>
                        <th>Processo</th>
                        <th>Titular</th>
                        <th>Ação</th>
                    </tr>

                    <tbody data-bind="foreach: listaSubcontas">
                        <tr data-bind="css: { warning: $parent.subcontaSelecionada() == numeroSubconta() }">
                            <td data-bind="text: numeroSubconta"></td>
                            <td data-bind="text: saldoFormatado"></td>
                            <td data-bind="text: dataFormatada"></td>
                            <td data-bind="text: numeroProcesso"></td>
                            <td data-bind="text: titular"></td>
                            <td><a href="#" data-bind="click: $parent.GetMovimentacoesSubconta" title="Visualizar Movimentações"><i class="fa fa-list fa-lg"></i></a></td>
                        </tr>
                    </tbody>
                </table>

                <!--
                <nav>
                    <ul class="pager">
                        <li><a href="#">Anterior</a></li>
                        <li><a href="#">Próximo</a></li>
                    </ul>
                </nav>
                -->

                <div data-bind="fadeVisible: isExibirPainelMovimentacao()">
                    <div class="alert alert-info">
                        <strong>Subconta:</strong> <span class="badge badge-info" data-bind="text: subcontaSelecionada()"></span><br/>
                        <small>Exibindo <span class="badge badge-info" data-bind="text: listaMovimentacoes().length"></span> registro(s) de movimentação.</small>
                    </div>
                </div>

            </div> <!-- fim if -->

        </div>


        <!-- Rodape -->
        <hr />
        <footer>
            <p>&copy; <span data-bind="text: new Date().toLocaleString()"></span> - KnockoutJS 3.3.0 + C#.NET WebApi 2 - by Leandro Almeida</p>
        </footer>
    </div>

    <!-- Scripts/Knockout -->
    <script src="../Scripts/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="../Scripts/bootstrap.min.js"></script>
    <script src="../Scripts/knockout-3.3.0.debug.js" type="text/javascript"></script>
    <script src="../Scripts/numeraljs/numeral.min.js"></script>
    <script src="../Scripts/numeraljs/languages/pt-br.min.js"></script>
    <script src="../Scripts/waitMe.min.js"></script>

    <script type="text/javascript">
        /*
        * Parametro: objeto javascript simples com os atributos da subconta:
        *    var subconta = {
        *        id: <id>,
        *        numeroSubconta: "<nrSubconta>",
        *        numeroProcesso: "<nrProcesso>",
        *        titular: "<nomeTitular>",
        *        dataAbertura: "<data>",
        *        saldo: <valorSaldo>
        *    };
        */
        function Subconta(pSubconta) {
            var self = this;
            self.id = ko.observable(pSubconta.id);
            self.numeroSubconta = ko.observable(pSubconta.numeroSubconta);
            self.numeroProcesso = ko.observable(pSubconta.numeroProcesso);
            self.titular = ko.observable(pSubconta.titular);
            self.dataAbertura = ko.observable(pSubconta.dataAbertura);
            self.saldo = ko.observable(pSubconta.saldo);

            self.dataFormatada = ko.computed(function () {
                return new Date(self.dataAbertura()).toLocaleString();
            });

            self.saldoFormatado = ko.computed(function () {
                return numeral(self.saldo()).format('$0,0.00');
            });
        }

        /*
        * Objeto que representa o View-Model desta tela.
        */
        function SubcontaViewModel() {
            var self = this;

            // campos de pesquisa
            self.pSubconta = ko.observable('');
            self.pProcesso = ko.observable('');
            self.pTitular = ko.observable('');
            self.boolExibirPainelResultado = ko.observable(false);
            self.subcontaSelecionada = ko.observable('');

            // lista de objetos retornados do servidor
            self.listaSubcontas = ko.observableArray([]);
            self.listaMovimentacoes = ko.observableArray([]);

            // pesquisa subcontas no SubcontasController
            self.GetSubcontas = function (objForm) {

                var p1 = (self.pSubconta().length == 0 ? "''" : self.pSubconta()) + '/';
                var p2 = (self.pProcesso().length == 0 ? "''" : self.pProcesso()) + '/';
                var p3 = (self.pTitular().length == 0 ? "''" : self.pTitular());

                // realiza chamada ajax
                // TODO: mudar url do browser com os parametros de pesquisa (Sammy plugin?)
                console.log('/api/Subconta/' + p1 + p2 + p3);
                //location.hash = p1 + p2 + p3;

                $.ajax('/api/Subconta/' + p1 + p2 + p3,
                    {
                        method: 'GET',
                        dataType: "json",
                        data: {},
                        beforeSend: function () {
                            self.boolExibirPainelResultado(false);
                            self.listaSubcontas([]);
                        },

                        success: function (data) {

                            console.log(data);

                            var mappedData = ko.utils.arrayMap(data, function (item) {
                                return new Subconta(item);
                            });

                            //self.listaSubcontas.push.apply(self.listaSubcontas, mappedData);
                            self.listaSubcontas(mappedData);
                            //self.subcontaSelecionada('');
                        },

                        complete: function () {
                            self.boolExibirPainelResultado(true);
                            // esconder ajax loading
                        }
                    });
            };

            self.GetMovimentacoesSubconta = function (obj) {
                console.log("Subconta:", obj.numeroSubconta());

                self.subcontaSelecionada('');
                // ajax
                self.subcontaSelecionada(obj.numeroSubconta());
            };

            self.LimparCampos = function () {
                self.pSubconta('');
                self.pProcesso('');
                self.pTitular('');
                self.subcontaSelecionada('');
                self.listaSubcontas([]);
                self.listaMovimentacoes([]);
                self.boolExibirPainelResultado(false);
            };

            // Função auxiliar para informar se deve habilitar botao pesquisar
            self.isExibirBotaoPesquisar = function () {
                return (self.pSubconta() || self.pProcesso() || self.pTitular());
            };

            self.isExibirPainelResultado = function () {
                return self.boolExibirPainelResultado();
            };

            self.isExibirPainelMovimentacao = function () {
                return (self.subcontaSelecionada().length > 0);
            };
        }

        // Efeito de FadeIn/FadeOut do jQuery associado ao data-bind 'fadeVisible'
        ko.bindingHandlers.fadeVisible = {
            init: function (element, valueAccessor) {
                // Initially set the element to be instantly visible/hidden depending on the value
                var value = valueAccessor();
                $(element).toggle(ko.unwrap(value)); // Use "unwrapObservable" so we can handle values that may or may not be observable
            },
            update: function (element, valueAccessor) {
                // Whenever the value subsequently changes, slowly fade the element in or out
                var value = valueAccessor();
                ko.unwrap(value) ? $(element).fadeIn() : $(element).fadeOut();
            }
        };

        // Fade + Slide
        $.fn.slideDownFadeIn = function (speed) {
            return this.stop(true, true).fadeIn({ duration: speed, queue: false }).css('display', 'none').slideDown(speed);
        };
        $.fn.slideUpFadeOut = function (speed) {
            return this.stop(true, true).slideUp({ duration: speed, queue: false }).fadeOut(speed);
        };

        $(document).ready(function () {
            numeral.language('pt-br');

            // Configura eventos Ajax
            $(document).ajaxSend(function () {
                // Espera 500ms antes de exibir o Ajax Loading
                setTimeout(function () {
                    if ($.active > 0) {
                        $(document.body).waitMe({ effect: 'img', source: '../Content/ajax.svg' })
                    }
                }, 500);
            });

            // Fecha Ajax Loading ao completar qq requisicao ajax
            $(document).ajaxComplete(function () {
                if ($.active == 0) {
                    $(document.body).waitMe('hide');
                }
            });

            ko.applyBindings(new SubcontaViewModel());
        });
    </script>

</body>
</html>
